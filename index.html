<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Idea Note</title>

  <!-- PWA -->
  <link rel="manifest" href="/idea_note/manifest.json" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f7fa;
      padding: 40px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 24px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    textarea {
      width: 100%;
      height: 160px;
      padding: 12px;
      font-size: 14px;
    }
    button {
      margin-top: 10px;
      margin-right: 5px;
      padding: 10px 16px;
      cursor: pointer;
    }
    .date {
      font-size: 12px;
      color: #666;
    }
    .hidden {
      display: none;
    }
    .note-item {
      margin-bottom: 10px;
    }
  </style>

  <!-- ğŸ”’ URL ì •ê·œí™” (ê°€ì¥ ì¤‘ìš”) -->
  <script>
    // ì–´ë–¤ ê²½ë¡œë¡œ ë“¤ì–´ì™€ë„ í•­ìƒ ë™ì¼í•œ URLë¡œ í†µì¼
    if (!location.search.includes("source=pwa")) {
      const newUrl = location.pathname + "?source=pwa";
      location.replace(newUrl);
    }
  </script>
</head>

<body>
<div class="container">

  <!-- ëª©ë¡ í™”ë©´ -->
  <div id="home">
    <h2>ğŸ“š ì•„ì´ë””ì–´ ëª©ë¡</h2>
    <button onclick="goWrite()">âœ ìƒˆ ê¸€ ì‘ì„±</button>
    <button onclick="exportNotes()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
    <button onclick="importNotes()">ğŸ“¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <input type="file" id="fileInput" accept=".json" hidden>
    <hr>
    <div id="list"></div>
  </div>

  <!-- ì‘ì„± / ìˆ˜ì • í™”ë©´ -->
  <div id="write" class="hidden">
    <h2 id="writeTitle">âœ ê¸€ ì‘ì„±</h2>
    <textarea id="content"></textarea><br>
    <button onclick="saveNote()">ğŸ’¾ ì €ì¥</button>
    <button onclick="cancelWrite()">â†© ì·¨ì†Œ</button>
    <button onclick="deleteCurrent()">ğŸ—‘ ì‚­ì œ</button>
  </div>

</div>

<script>
/* ===== ìƒíƒœ ===== */
let notes = JSON.parse(localStorage.getItem("notes")) || [];
let editingId = null;

/* ===== í™”ë©´ ì „í™˜ ===== */
function showHome() {
  document.getElementById("home").classList.remove("hidden");
  document.getElementById("write").classList.add("hidden");
  renderList();
}

function showWrite() {
  document.getElementById("home").classList.add("hidden");
  document.getElementById("write").classList.remove("hidden");
}

function cancelWrite() {
  showHome();
}

/* ===== ëª©ë¡ ===== */
function renderList() {
  const list = document.getElementById("list");
  list.innerHTML = "";

  if (notes.length === 0) {
    list.innerHTML = "<p>ì‘ì„±ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
    return;
  }

  notes.forEach((note, index) => {
    const div = document.createElement("div");
    div.className = "note-item";
    div.innerHTML = `
      <strong>${index + 1}. ${note.content.slice(0, 20)}...</strong>
      <div class="date">${note.date}</div>
      <button onclick="editNote(${note.id})">âœï¸ ìˆ˜ì •</button>
      <button onclick="deleteNote(${note.id})">ğŸ—‘ ì‚­ì œ</button>
      <hr>
    `;
    list.appendChild(div);
  });
}

/* ===== ì‘ì„± / ìˆ˜ì • ===== */
function goWrite() {
  editingId = null;
  document.getElementById("content").value = "";
  document.getElementById("writeTitle").innerText = "âœ ê¸€ ì‘ì„±";
  showWrite();
}

function editNote(id) {
  const note = notes.find(n => n.id === id);
  if (!note) return;

  editingId = id;
  document.getElementById("content").value = note.content;
  document.getElementById("writeTitle").innerText = "âœï¸ ê¸€ ìˆ˜ì •";
  showWrite();
}

function saveNote() {
  const content = document.getElementById("content").value.trim();
  if (!content) {
    alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  if (editingId === null) {
    notes.unshift({
      id: Date.now(),
      content,
      date: new Date().toLocaleString()
    });
  } else {
    const note = notes.find(n => n.id === editingId);
    if (note) {
      note.content = content;
      note.date = new Date().toLocaleString();
    }
  }

  localStorage.setItem("notes", JSON.stringify(notes));
  showHome();
}

/* ===== ì‚­ì œ ===== */
function deleteNote(id) {
  if (!confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) return;
  notes = notes.filter(n => n.id !== id);
  localStorage.setItem("notes", JSON.stringify(notes));
  showHome();
}

function deleteCurrent() {
  if (editingId === null) {
    alert("ì‚­ì œí•  ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  deleteNote(editingId);
}

/* ===== ë‚´ë³´ë‚´ê¸° / ë¶ˆëŸ¬ì˜¤ê¸° ===== */
function exportNotes() {
  const data = JSON.stringify(notes, null, 2);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "idea-note-backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importNotes() {
  document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const imported = JSON.parse(ev.target.result);
      if (!Array.isArray(imported)) throw new Error();
      if (!confirm("ê¸°ì¡´ ë©”ëª¨ë¥¼ ë®ì–´ì“¸ê¹Œìš”?")) return;

      notes = imported;
      localStorage.setItem("notes", JSON.stringify(notes));
      renderList();
      alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
    } catch {
      alert("ì˜¬ë°”ë¥¸ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.");
    }
  };
  reader.readAsText(file);
});

/* ===== ì´ˆê¸° ì‹¤í–‰ ===== */
showHome();

/* ===== Service Worker ë“±ë¡ ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/idea_note/service-worker.js");
}
</script>

</body>
</html>
